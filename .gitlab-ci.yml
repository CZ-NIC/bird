## TODO: find out how to generate this file by another yaml file.
## Gitlab can do it but it is a stupid idea to mess with this
## when releasing 4 versions at once. See ya later!
##                                              -- Maria, April 2025

variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_STRATEGY: fetch
  DOCKER_CMD: docker --config="$HOME/.docker/$CI_JOB_ID/"
  IMG_BASE: registry.nic.cz/labs/bird
  TOOLS_DIR: /home/gitlab-runner/bird-tools
  STAYRTR_BINARY: /usr/bin/stayrtr

stages:
  - prepare
  - test
  - release

.minimal: &minimal
  before_script:
    - apk add --update --no-cache python3 git bash
    - python3 -m venv venv
    - . venv/bin/activate
    - python3 -m ensurepip
    - pip3 install --no-cache --upgrade jinja2 pyyaml
  tags:
    - linux
    - docker

## Child pipelines for autotests
prepare:
  <<: *minimal
  stage: prepare
  script:
    - if bash ./tools/git-is-stable-branch $CI_COMMIT_BRANCH; then ./tools/git-check-commits; fi
    - 'cd misc/gitlab && python3 pipeline.py > pipeline.yml'
  artifacts:
    paths:
      - misc/gitlab/pipeline.yml
  rules:
  - if: $CI_COMMIT_BRANCH =~ /^(stable-.*|thread-next|master)$/
    when: always
  - if: $CI_COMMIT_MESSAGE =~ /^(fixup! )*WIP/
    when: never
  - when: always

child-run:
  stage: test
  trigger:
    include:
      - artifact: misc/gitlab/pipeline.yml
        job: prepare
    strategy: depend
  rules:
  - if: $CI_COMMIT_MESSAGE =~ /^(fixup! )*WIP/
    when: never
  - when: always

# Release confirmation job for tag pushing. As soon as we finish our web
# deployment automatic machinery, clicking the button is expected to
# publish the release info on our website.
#
# We are not there yet tho, too many other fish to fry.

publish-release:
  stage: release
  script:
  - "true"
  rules:
  - if: '$CI_COMMIT_TAG'
    when: manual
  - when: never
