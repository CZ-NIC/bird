###########################################################
#####                                                 #####
#####       DO  NOT  EDIT  THIS  FILE  BY  HAND       #####
#####                                                 #####
###########################################################
#####                                                 #####
##### This file is autogenerated from misc/gitlab/.   #####
##### Edit those files and run `make gitlab` instead. #####
#####                                                 #####
###########################################################

variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_STRATEGY: fetch
  DOCKER_CMD: docker --config="$HOME/.docker/$CI_JOB_ID/"
  IMG_BASE: registry.nic.cz/labs/bird
  TOOLS_DIR: /home/gitlab-runner/bird-tools
  STAYRTR_BINARY: /usr/local/bin/stayrtr
  APKG_VERSION: 0.5.1

stages:
  - consistency
  - image
  - build
  - pkg
  - install
  - test

## Common rules
# Ignore WIP commits
.never-wip: &never-wip
  if: $CI_COMMIT_MESSAGE =~ /^(fixup! )*WIP/
  when: never
# Run for stable branches
.if-stable: &if-stable
  if: ($CI_COMMIT_BRANCH =~ /^(stable-.*|thread-next|master)$/ || $CI_PIPELINE_SOURCE == "merge_request_event")
  when: always
# Do run for tags
.if-tag: &if-tag
  if: $CI_COMMIT_TAG
  when: always
# Never run for tags
.never-tag: &never-tag
  if: $CI_COMMIT_TAG
  when: never

## Consistency checks for stable branches
commit-messages:
  stage: consistency
  image: registry.nic.cz/labs/bird:docbuilder
  script:
  - tools/git-check-commits
  rules:
  - *if-stable
  - when: never

## Tag check
tag-collect:
  stage: consistency
  image: registry.nic.cz/labs/bird:docbuilder
  script:
  - python3 -m venv venv
  - . venv/bin/activate
  - pip3 install requests
  - tools/git-check-tag-local $CI_COMMIT_TAG
  - tools/git-check-tag-ci $CI_COMMIT_SHA
  artifacts:
    paths:
      - obj/doc/bird-singlepage.html
      - bird-*.tar.gz
      - pkg/pkgs/*
      - pkg/srcpkgs/*
  rules:
  - *if-tag
  - when: never

## Default test job rules
.test-job: &test-job
  rules:
  - *never-wip
  - *never-tag
  - when: always

## Package installability checks

.install-rpm: &install-rpm
  <<: *test-job
  stage: install
  script:
    # check that bird is _not_ installed now and no user or group bird exists
    - |
      if bird --version >/dev/null 2>&1; then
        echo "Error: BIRD unexpectedly installed"
        exit 1
      fi
      if id -g bird >/dev/null 2>&1; then
        echo "Error: User group 'bird' exist before installation"
        exit 1
      fi
      if id -u bird >/dev/null 2>&1; then
        echo "Error: User 'bird' exist before installation"
        exit 1
      fi
    # install packages
    - $PREINSTALL
    - curl -k $REPO_URL > bird.repo
    - $ADDREPO
    - $REPOLIST
    - $LIST
    - $INSTALL
    # test that installation is successful
    - ./tools/test-install "$CI_COMMIT_MESSAGE"


install-centos-7-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:centos-7-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/centos/7/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-centos-8-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:centos-8-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/centos/8/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-rocky-08-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:rocky-08-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/rocky/08/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-rocky-09-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:rocky-09-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/rocky/09/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-32-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-32-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/32/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-33-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-33-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/33/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-opensuse-15.0-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.0-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.0/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-opensuse-15.1-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.1-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.1/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-opensuse-15.2-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.2-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.2/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-opensuse-15.3-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.3-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.3/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-opensuse-15.4-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.4-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.4/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-opensuse-15.5-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:opensuse-15.5-amd64
  variables:
    PREINSTALL: zypper in curl
    ADDREPO: zypper ar bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/opensuse/15.5/x86_64/bird.repo
    REPOLIST: zypper lr
    LIST: zypper search bird
    INSTALL: zypper in bird=3.1.5-cznic.1

install-fedora-34-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-34-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/34/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-35-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-35-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/35/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-36-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-36-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/36/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-37-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-37-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/37/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-38-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-38-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/38/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-39-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-39-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/39/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-40-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-40-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/40/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-41-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-41-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/41/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

install-fedora-42-amd64:
  <<: *install-rpm
  image: registry.nic.cz/labs/bird:fedora-42-amd64
  variables:
    PREINSTALL: true
    ADDREPO: cp bird.repo /etc/yum.repos.d/bird.repo
    REPO_URL: https://branch.www.bird.office.nic.cz/fedora/42/x86_64/bird.repo
    REPOLIST: yum repolist
    LIST: yum --showduplicates list bird
    INSTALL: yum install bird-3.1.5-cznic.1

