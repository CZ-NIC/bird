###########################################################
#####                                                 #####
#####       DO  NOT  EDIT  THIS  FILE  BY  HAND       #####
#####                                                 #####
###########################################################
#####                                                 #####
##### This file is autogenerated from misc/gitlab/.   #####
##### Edit those files and run `make gitlab` instead. #####
#####                                                 #####
###########################################################

variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_STRATEGY: fetch
  DOCKER_CMD: docker --config="$HOME/.docker/$CI_JOB_ID/"
  IMG_BASE: registry.nic.cz/labs/bird
  TOOLS_DIR: /home/gitlab-runner/bird-tools
  STAYRTR_BINARY: /usr/local/bin/stayrtr
  APKG_VERSION: 0.5.1

stages:
  - consistency
  - image
  - build
  - pkg
  - install
  - test

## Common rules
# Ignore WIP commits
.never-wip: &never-wip
  if: $CI_COMMIT_MESSAGE =~ /^(fixup! )*WIP/
  when: never
# Run for stable branches
.if-stable: &if-stable
  if: ($CI_COMMIT_BRANCH =~ /^(stable-.*|thread-next|master)$/ || $CI_PIPELINE_SOURCE == "merge_request_event")
  when: always
# Do run for tags
.if-tag: &if-tag
  if: $CI_COMMIT_TAG
  when: always
# Never run for tags
.never-tag: &never-tag
  if: $CI_COMMIT_TAG
  when: never

## Consistency checks for stable branches
commit-messages:
  stage: consistency
  image: registry.nic.cz/labs/bird:docbuilder
  script:
  - tools/git-check-commits
  rules:
  - *if-stable
  - when: never

## Tag check
tag-collect:
  stage: consistency
  image: registry.nic.cz/labs/bird:docbuilder
  script:
  - python3 -m venv venv
  - . venv/bin/activate
  - pip3 install requests
  - tools/git-check-tag-local $CI_COMMIT_TAG
  - tools/git-check-tag-ci $CI_COMMIT_SHA
  artifacts:
    paths:
      - obj/doc/bird-singlepage.html
      - bird-*.tar.gz
      - pkg/pkgs/*
      - pkg/srcpkgs/*
  rules:
  - *if-tag
  - when: never

## Default test job rules
.test-job: &test-job
  rules:
  - *never-wip
  - *never-tag
  - when: always

## Package installability checks

.install-suse: &install-suse
  <<: *test-job
  stage: install
  script:
    # check that bird is _not_ installed now and no user or group bird exists
    - |
      if bird --version >/dev/null 2>&1; then
        echo "Error: BIRD unexpectedly installed"
        exit 1
      fi
      if id -g bird >/dev/null 2>&1; then
        echo "Error: User group 'bird' exist before installation"
        exit 1
      fi
      if id -u bird >/dev/null 2>&1; then
        echo "Error: User 'bird' exist before installation"
        exit 1
      fi
    # install packages
    - zypper in -y curl openssl ca-certificates strace
#    - openssl s_client -showcerts -connect branch.www.bird.office.nic.cz:443 </dev/null 2>/dev/null | openssl x509 -outform PEM > office.crt
    - curl -k https://branch.www.bird.office.nic.cz/cznic.crt --output cznic.crt
    - curl -k https://branch.www.bird.office.nic.cz/servers.crt --output servers.crt
    - trust anchor cznic.crt
    - trust anchor servers.crt
    - curl $REPO_URL > bird.repo
    - curl https://branch.www.bird.office.nic.cz/maria.gpg > bird-maria.gpg
    - curl https://branch.www.bird.office.nic.cz/meow.gpg > bird-meow.gpg
    - rpm --import bird-maria.gpg
    - rpm --import bird-meow.gpg
    - zypper --gpg-auto-import-keys ar bird.repo
    - zypper --gpg-auto-import-keys ref bird
    - zypper --gpg-auto-import-keys search bird
    - strace -o strout -ff $INSTALL
    # test that installation is successful
    - ./tools/test-install "$CI_COMMIT_MESSAGE"
  artifacts:
    when: on_failure
    paths:
      - 'strout*'

.install-rpm: &install-rpm
  <<: *test-job
  stage: install
  script:
    # check that bird is _not_ installed now and no user or group bird exists
    - |
      if bird --version >/dev/null 2>&1; then
        echo "Error: BIRD unexpectedly installed"
        exit 1
      fi
      if id -g bird >/dev/null 2>&1; then
        echo "Error: User group 'bird' exist before installation"
        exit 1
      fi
      if id -u bird >/dev/null 2>&1; then
        echo "Error: User 'bird' exist before installation"
        exit 1
      fi
    # install packages
    - yum install -y openssl ca-certificates strace
    - openssl s_client -showcerts -connect branch.www.bird.office.nic.cz:443 </dev/null 2>/dev/null | openssl x509 -outform PEM > /etc/pki/ca-trust/source/anchors/office.crt
    - curl -k https://branch.www.bird.office.nic.cz/cznic.crt --output /etc/pki/ca-trust/source/anchors/cznic.crt
    - curl -k https://branch.www.bird.office.nic.cz/servers.crt --output /etc/pki/ca-trust/source/anchors/servers.crt
    - update-ca-trust
    - curl $REPO_URL > bird.repo
    - curl https://branch.www.bird.office.nic.cz/maria.gpg > /etc/pki/rpm-gpg/bird-maria.gpg
    - curl https://branch.www.bird.office.nic.cz/meow.gpg > /etc/pki/rpm-gpg/bird-meow.gpg
    - rpmkeys --import /etc/pki/rpm-gpg/bird-maria.gpg
    - rpmkeys --import /etc/pki/rpm-gpg/bird-meow.gpg
    - cp bird.repo /etc/yum.repos.d/bird.repo
    - yum list bird
    - strace -o strout -ff $INSTALL
    # test that installation is successful
    - ./tools/test-install "$CI_COMMIT_MESSAGE"
  artifacts:
    when: on_failure
    paths:
      - 'strout*'

{% for dist in distros %}{% if "rpm" in dist["type"] %}
install-{{ dist["name"] }}:
  <<: *{% if "opensuse" in dist["name"] %}install-suse{% else %}install-rpm{% endif %}
  image: registry.nic.cz/labs/bird:{{ dist["name"] }}
  variables:
    REPO_URL: {{ dist["branchrepo"] }}
    INSTALL: {% if "opensuse" in dist["name"] %}zypper in -y bird=3.1.5-cznic.1{% else %}yum install -y bird-3.1.5-cznic.1{{ dist["vsuf"] }}{% endif %}
{% endif %}{% endfor %}
